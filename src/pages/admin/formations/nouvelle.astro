---
import Layout from '../../../layouts/Layout.astro';
---

<Layout title="Nouvelle formation - Administration">
  <div class="min-h-screen bg-gray-50">
    <!-- Header Admin -->
    <header class="bg-white shadow-sm border-b">
      <div class="container py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-4">
            <a href="/admin/formations" class="text-secondary-600 hover:text-primary-600">← Retour</a>
            <h1 class="text-2xl font-bold text-primary-800">Nouvelle formation</h1>
          </div>
          <div class="flex space-x-2">
            <button type="button" class="btn btn-outline" onclick="saveAsDraft()">Enregistrer comme brouillon</button>
            <button type="submit" form="formation-form" class="btn btn-primary">Publier</button>
          </div>
        </div>
      </div>
    </header>

    <div class="container py-8">
      <form id="formation-form" class="space-y-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Contenu principal -->
          <div class="lg:col-span-2 space-y-6">
            <!-- Informations générales -->
            <div class="bg-white p-6 rounded-lg shadow-soft">
              <h3 class="text-lg font-medium text-gray-900 mb-4">Informations générales</h3>
              <div class="space-y-4">
                <div>
                  <label for="title" class="block text-sm font-medium text-gray-700 mb-2">Nom de la formation *</label>
                  <input 
                    type="text" 
                    id="title" 
                    name="title" 
                    required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    placeholder="Ex: Génie Civil, Master Intelligence Artificielle..."
                  />
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label for="type" class="block text-sm font-medium text-gray-700 mb-2">Type de formation *</label>
                    <select 
                      id="type" 
                      name="type" 
                      required
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    >
                      <option value="">Sélectionner un type</option>
                      <option value="diplome-ingenieur">Diplôme d'ingénieur</option>
                      <option value="master">Master</option>
                      <option value="licence">Licence</option>
                      <option value="formation-continue">Formation continue</option>
                      <option value="doctorat">Doctorat</option>
                    </select>
                  </div>

                  <div>
                    <label for="duration" class="block text-sm font-medium text-gray-700 mb-2">Durée *</label>
                    <select 
                      id="duration" 
                      name="duration" 
                      required
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    >
                      <option value="">Sélectionner la durée</option>
                      <option value="1 an">1 an</option>
                      <option value="2 ans">2 ans</option>
                      <option value="3 ans">3 ans</option>
                      <option value="4 ans">4 ans</option>
                      <option value="5 ans">5 ans</option>
                      <option value="6 mois">6 mois</option>
                      <option value="Variable">Variable</option>
                    </select>
                  </div>
                </div>

                <div>
                  <label for="description" class="block text-sm font-medium text-gray-700 mb-2">Description courte *</label>
                  <textarea 
                    id="description" 
                    name="description" 
                    rows="3"
                    required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    placeholder="Description résumée de la formation (150-200 caractères)"
                  ></textarea>
                  <p class="text-sm text-gray-500 mt-1">Cette description apparaîtra dans les listes et cartes de formation.</p>
                </div>

                <div>
                  <label for="detailed-description" class="block text-sm font-medium text-gray-700 mb-2">Description détaillée</label>
                  <textarea 
                    id="detailed-description" 
                    name="detailed_description" 
                    rows="6"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    placeholder="Description complète de la formation, objectifs, débouchés..."
                  ></textarea>
                </div>
              </div>
            </div>

            <!-- Programme et modules -->
            <div class="bg-white p-6 rounded-lg shadow-soft">
              <h3 class="text-lg font-medium text-gray-900 mb-4">Programme de formation</h3>
              <div class="space-y-4">
                <div>
                  <label for="objectives" class="block text-sm font-medium text-gray-700 mb-2">Objectifs pédagogiques</label>
                  <textarea 
                    id="objectives" 
                    name="objectives" 
                    rows="4"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    placeholder="Listez les principaux objectifs d'apprentissage..."
                  ></textarea>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Modules principaux</label>
                  <div id="modules-container" class="space-y-2">
                    <div class="flex items-center space-x-2">
                      <input 
                        type="text" 
                        name="modules[]" 
                        class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                        placeholder="Nom du module"
                      />
                      <button type="button" onclick="removeModule(this)" class="text-red-600 hover:text-red-800">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                  <button type="button" onclick="addModule()" class="mt-2 text-primary-600 hover:text-primary-700 text-sm font-medium">
                    + Ajouter un module
                  </button>
                </div>

                <div>
                  <label for="prerequisites" class="block text-sm font-medium text-gray-700 mb-2">Prérequis</label>
                  <textarea 
                    id="prerequisites" 
                    name="prerequisites" 
                    rows="3"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    placeholder="Diplômes requis, niveau de langue, compétences..."
                  ></textarea>
                </div>
              </div>
            </div>

            <!-- Débouchés et carrières -->
            <div class="bg-white p-6 rounded-lg shadow-soft">
              <h3 class="text-lg font-medium text-gray-900 mb-4">Débouchés professionnels</h3>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Métiers visés</label>
                  <div id="careers-container" class="space-y-2">
                    <div class="flex items-center space-x-2">
                      <input 
                        type="text" 
                        name="careers[]" 
                        class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                        placeholder="Intitulé du métier"
                      />
                      <button type="button" onclick="removeCareer(this)" class="text-red-600 hover:text-red-800">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                  <button type="button" onclick="addCareer()" class="mt-2 text-primary-600 hover:text-primary-700 text-sm font-medium">
                    + Ajouter un métier
                  </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label for="employment-rate" class="block text-sm font-medium text-gray-700 mb-2">Taux d'insertion (%)</label>
                    <input 
                      type="number" 
                      id="employment-rate" 
                      name="employment_rate" 
                      min="0" 
                      max="100"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                      placeholder="95"
                    />
                  </div>

                  <div>
                    <label for="average-salary" class="block text-sm font-medium text-gray-700 mb-2">Salaire moyen (€)</label>
                    <input 
                      type="number" 
                      id="average-salary" 
                      name="average_salary" 
                      min="0"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                      placeholder="35000"
                    />
                  </div>
                </div>
              </div>
            </div>

            <!-- SEO -->
            <div class="bg-white p-6 rounded-lg shadow-soft">
              <h3 class="text-lg font-medium text-gray-900 mb-4">Optimisation SEO</h3>
              <div class="space-y-4">
                <div>
                  <label for="meta-title" class="block text-sm font-medium text-gray-700 mb-2">Titre SEO</label>
                  <input 
                    type="text" 
                    id="meta-title" 
                    name="meta_title"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    placeholder="Titre pour les moteurs de recherche"
                  />
                  <p class="text-sm text-gray-500 mt-1">Recommandé : 50-60 caractères</p>
                </div>
                <div>
                  <label for="meta-description" class="block text-sm font-medium text-gray-700 mb-2">Description SEO</label>
                  <textarea 
                    id="meta-description" 
                    name="meta_description" 
                    rows="2"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    placeholder="Description pour les moteurs de recherche"
                  ></textarea>
                  <p class="text-sm text-gray-500 mt-1">Recommandé : 150-160 caractères</p>
                </div>
                <div>
                  <label for="keywords" class="block text-sm font-medium text-gray-700 mb-2">Mots-clés</label>
                  <input 
                    type="text" 
                    id="keywords" 
                    name="keywords"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    placeholder="Séparez les mots-clés par des virgules"
                  />
                </div>
              </div>
            </div>
          </div>

          <!-- Sidebar -->
          <div class="space-y-6">
            <!-- Statut et publication -->
            <div class="bg-white p-6 rounded-lg shadow-soft">
              <h3 class="text-lg font-medium text-gray-900 mb-4">Publication</h3>
              <div class="space-y-4">
                <div>
                  <label for="status" class="block text-sm font-medium text-gray-700 mb-2">Statut</label>
                  <select 
                    id="status" 
                    name="status"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                  >
                    <option value="draft">Brouillon</option>
                    <option value="published">Publié</option>
                    <option value="archived">Archivé</option>
                  </select>
                </div>
                <div>
                  <label for="featured" class="flex items-center">
                    <input 
                      type="checkbox" 
                      id="featured" 
                      name="featured"
                      class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"
                    />
                    <span class="ml-2 text-sm text-gray-900">Formation mise en avant</span>
                  </label>
                </div>
              </div>
            </div>

            <!-- Catégorie et domaine -->
            <div class="bg-white p-6 rounded-lg shadow-soft">
              <h3 class="text-lg font-medium text-gray-900 mb-4">Classification</h3>
              <div class="space-y-4">
                <div>
                  <label for="domain" class="block text-sm font-medium text-gray-700 mb-2">Domaine</label>
                  <select 
                    id="domain" 
                    name="domain"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                  >
                    <option value="">Sélectionner un domaine</option>
                    <option value="energie">Énergie</option>
                    <option value="environnement">Environnement</option>
                    <option value="numerique">Numérique</option>
                    <option value="genie-civil">Génie Civil</option>
                    <option value="agronomie">Agronomie</option>
                    <option value="sante">Santé</option>
                    <option value="communication">Communication</option>
                    <option value="droit">Droit</option>
                    <option value="economie">Économie</option>
                  </select>
                </div>

                <div>
                  <label for="level" class="block text-sm font-medium text-gray-700 mb-2">Niveau d'études</label>
                  <select 
                    id="level" 
                    name="level"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                  >
                    <option value="">Sélectionner le niveau</option>
                    <option value="bac+3">Bac+3</option>
                    <option value="bac+5">Bac+5</option>
                    <option value="bac+8">Bac+8</option>
                    <option value="formation-continue">Formation continue</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Image de la formation -->
            <div class="bg-white p-6 rounded-lg shadow-soft">
              <h3 class="text-lg font-medium text-gray-900 mb-4">Image de la formation</h3>
              <div class="space-y-4">
                <div>
                  <input 
                    type="file" 
                    id="formation-image" 
                    name="formation_image"
                    accept="image/*"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                  />
                </div>
                <div>
                  <label for="image-alt" class="block text-sm font-medium text-gray-700 mb-2">Texte alternatif</label>
                  <input 
                    type="text" 
                    id="image-alt" 
                    name="image_alt"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    placeholder="Description de l'image"
                  />
                </div>
                <div id="image-preview" class="hidden">
                  <img id="preview-img" src="" alt="Aperçu" class="w-full h-32 object-cover rounded-md" />
                </div>
              </div>
            </div>

            <!-- Informations pratiques -->
            <div class="bg-white p-6 rounded-lg shadow-soft">
              <h3 class="text-lg font-medium text-gray-900 mb-4">Informations pratiques</h3>
              <div class="space-y-4">
                <div>
                  <label for="campus" class="block text-sm font-medium text-gray-700 mb-2">Campus</label>
                  <select 
                    id="campus" 
                    name="campus"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                  >
                    <option value="">Sélectionner un campus</option>
                    <option value="principal">Campus Principal</option>
                    <option value="sciences">Campus Sciences</option>
                    <option value="technique">Campus Technique</option>
                  </select>
                </div>

                <div>
                  <label for="capacity" class="block text-sm font-medium text-gray-700 mb-2">Capacité d'accueil</label>
                  <input 
                    type="number" 
                    id="capacity" 
                    name="capacity" 
                    min="1"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    placeholder="30"
                  />
                </div>

                <div>
                  <label for="tuition-fees" class="block text-sm font-medium text-gray-700 mb-2">Frais de scolarité (€/an)</label>
                  <input 
                    type="number" 
                    id="tuition-fees" 
                    name="tuition_fees" 
                    min="0"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    placeholder="5000"
                  />
                </div>

                <div>
                  <label for="application-deadline" class="block text-sm font-medium text-gray-700 mb-2">Date limite de candidature</label>
                  <input 
                    type="date" 
                    id="application-deadline" 
                    name="application_deadline"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                  />
                </div>
              </div>
            </div>

            <!-- Contact et responsable -->
            <div class="bg-white p-6 rounded-lg shadow-soft">
              <h3 class="text-lg font-medium text-gray-900 mb-4">Contact</h3>
              <div class="space-y-4">
                <div>
                  <label for="coordinator-name" class="block text-sm font-medium text-gray-700 mb-2">Responsable de formation</label>
                  <input 
                    type="text" 
                    id="coordinator-name" 
                    name="coordinator_name"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    placeholder="Nom du responsable"
                  />
                </div>
                <div>
                  <label for="coordinator-email" class="block text-sm font-medium text-gray-700 mb-2">Email du responsable</label>
                  <input 
                    type="email" 
                    id="coordinator-email" 
                    name="coordinator_email"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    placeholder="responsable@m2epolytech.fr"
                  />
                </div>
                <div>
                  <label for="coordinator-phone" class="block text-sm font-medium text-gray-700 mb-2">Téléphone</label>
                  <input 
                    type="tel" 
                    id="coordinator-phone" 
                    name="coordinator_phone"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    placeholder="+33 1 23 45 67 89"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Génération automatique du titre SEO
    document.getElementById('title').addEventListener('input', function(e) {
      const metaTitle = document.getElementById('meta-title');
      if (!metaTitle.value) {
        metaTitle.value = e.target.value;
      }
    });

    // Prévisualisation de l'image
    document.getElementById('formation-image').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('preview-img').src = e.target.result;
          document.getElementById('image-preview').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      }
    });

    // Gestion des modules
    function addModule() {
      const container = document.getElementById('modules-container');
      const div = document.createElement('div');
      div.className = 'flex items-center space-x-2';
      div.innerHTML = `
        <input 
          type="text" 
          name="modules[]" 
          class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
          placeholder="Nom du module"
        />
        <button type="button" onclick="removeModule(this)" class="text-red-600 hover:text-red-800">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
          </svg>
        </button>
      `;
      container.appendChild(div);
    }

    function removeModule(button) {
      button.parentElement.remove();
    }

    // Gestion des métiers
    function addCareer() {
      const container = document.getElementById('careers-container');
      const div = document.createElement('div');
      div.className = 'flex items-center space-x-2';
      div.innerHTML = `
        <input 
          type="text" 
          name="careers[]" 
          class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
          placeholder="Intitulé du métier"
        />
        <button type="button" onclick="removeCareer(this)" class="text-red-600 hover:text-red-800">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
          </svg>
        </button>
      `;
      container.appendChild(div);
    }

    function removeCareer(button) {
      button.parentElement.remove();
    }

    // Sauvegarde en brouillon
    function saveAsDraft() {
      document.getElementById('status').value = 'draft';
      document.getElementById('formation-form').submit();
    }

    // Soumission du formulaire
    document.getElementById('formation-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      
      // Collecte des modules
      const modules = Array.from(document.querySelectorAll('input[name="modules[]"]'))
        .map(input => input.value)
        .filter(value => value.trim() !== '');
      
      // Collecte des métiers
      const careers = Array.from(document.querySelectorAll('input[name="careers[]"]'))
        .map(input => input.value)
        .filter(value => value.trim() !== '');
      
      // Ajout des données collectées
      formData.set('modules', JSON.stringify(modules));
      formData.set('careers', JSON.stringify(careers));
      
      console.log('Données de la formation:', Object.fromEntries(formData));
      
      // Ici, vous ajouteriez la logique pour envoyer les données à votre API
      alert('Formation sauvegardée avec succès !');
    });

    // Validation en temps réel
    document.getElementById('title').addEventListener('blur', function() {
      if (this.value.length < 3) {
        this.classList.add('border-red-500');
      } else {
        this.classList.remove('border-red-500');
      }
    });

    document.getElementById('description').addEventListener('input', function() {
      const charCount = this.value.length;
      const maxChars = 200;
      
      if (charCount > maxChars) {
        this.classList.add('border-red-500');
      } else {
        this.classList.remove('border-red-500');
      }
    });
  </script>
</Layout>