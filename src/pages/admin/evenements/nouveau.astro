---
import Layout from '../../../layouts/Layout.astro';
export const prerender = false;
---

<Layout title="Nouvel événement - Administration">
  <div class="min-h-screen bg-gray-50">
    <!-- Header Admin -->
    <header class="bg-white shadow-sm border-b">
      <div class="container py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-4">
            <a href="/admin/evenements" class="text-secondary-600 hover:text-primary-600">← Retour</a>
            <h1 class="text-2xl font-bold text-primary-800">Nouvel événement</h1>
          </div>
          <div class="flex space-x-2">
            <button type="button" class="btn btn-outline" onclick="saveAsDraft()">Enregistrer comme brouillon</button>
            <button type="submit" form="event-form" class="btn btn-primary">Publier</button>
          </div>
        </div>
      </div>
    </header>

    <div class="container py-8">
      <form id="event-form" class="space-y-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Contenu principal -->
          <div class="lg:col-span-2 space-y-6">
            <!-- Informations de base -->
            <div class="bg-white p-6 rounded-lg shadow-soft">
              <h3 class="text-lg font-medium text-gray-900 mb-4">Informations générales</h3>
              <div class="space-y-4">
                <div>
                  <label for="title" class="block text-sm font-medium text-gray-700 mb-2">Titre de l'événement *</label>
                  <input 
                    type="text" 
                    id="title" 
                    name="title" 
                    required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    placeholder="Nom de l'événement"
                  />
                </div>
                <div>
                  <label for="description" class="block text-sm font-medium text-gray-700 mb-2">Description *</label>
                  <textarea 
                    id="description" 
                    name="description" 
                    rows="4"
                    required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    placeholder="Description détaillée de l'événement"
                  ></textarea>
                </div>
              </div>
            </div>

            <!-- Date et lieu -->
            <div class="bg-white p-6 rounded-lg shadow-soft">
              <h3 class="text-lg font-medium text-gray-900 mb-4">Date et lieu</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="start-date" class="block text-sm font-medium text-gray-700 mb-2">Date de début *</label>
                  <input 
                    type="date" 
                    id="start-date" 
                    name="start_date" 
                    required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                  />
                </div>
                <div>
                  <label for="start-time" class="block text-sm font-medium text-gray-700 mb-2">Heure de début *</label>
                  <input 
                    type="time" 
                    id="start-time" 
                    name="start_time" 
                    required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                  />
                </div>
                <div>
                  <label for="end-date" class="block text-sm font-medium text-gray-700 mb-2">Date de fin</label>
                  <input 
                    type="date" 
                    id="end-date" 
                    name="end_date"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                  />
                </div>
                <div>
                  <label for="end-time" class="block text-sm font-medium text-gray-700 mb-2">Heure de fin</label>
                  <input 
                    type="time" 
                    id="end-time" 
                    name="end_time"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                  />
                </div>
              </div>
              <div class="mt-4">
                <label for="location" class="block text-sm font-medium text-gray-700 mb-2">Lieu *</label>
                <input 
                  type="text" 
                  id="location" 
                  name="location" 
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                  placeholder="Lieu de l'événement"
                />
              </div>
            </div>

            <!-- Inscription -->
            <div class="bg-white p-6 rounded-lg shadow-soft">
              <h3 class="text-lg font-medium text-gray-900 mb-4">Inscription</h3>
              <div class="space-y-4">
                <div class="flex items-center">
                  <input 
                    type="checkbox" 
                    id="registration-required" 
                    name="registration_required"
                    class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"
                  />
                  <label for="registration-required" class="ml-2 block text-sm text-gray-900">
                    Inscription requise
                  </label>
                </div>
                <div id="registration-details" class="hidden space-y-4">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label for="max-participants" class="block text-sm font-medium text-gray-700 mb-2">Nombre max de participants</label>
                      <input 
                        type="number" 
                        id="max-participants" 
                        name="max_participants"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                        placeholder="Illimité si vide"
                      />
                    </div>
                    <div>
                      <label for="registration-deadline" class="block text-sm font-medium text-gray-700 mb-2">Date limite d'inscription</label>
                      <input 
                        type="date" 
                        id="registration-deadline" 
                        name="registration_deadline"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                      />
                    </div>
                  </div>
                  <div>
                    <label for="registration-url" class="block text-sm font-medium text-gray-700 mb-2">Lien d'inscription</label>
                    <input 
                      type="url" 
                      id="registration-url" 
                      name="registration_url"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                      placeholder="https://..."
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Sidebar -->
          <div class="space-y-6">
            <!-- Statut -->
            <div class="bg-white p-6 rounded-lg shadow-soft">
              <h3 class="text-lg font-medium text-gray-900 mb-4">Publication</h3>
              <div class="space-y-4">
                <div>
                  <label for="status" class="block text-sm font-medium text-gray-700 mb-2">Statut</label>
                  <select 
                    id="status" 
                    name="status"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                  >
                    <option value="draft">Brouillon</option>
                    <option value="published">Publié</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Catégorie -->
            <div class="bg-white p-6 rounded-lg shadow-soft">
              <h3 class="text-lg font-medium text-gray-900 mb-4">Catégorie</h3>
              <select 
                id="category" 
                name="category"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
              >
                <option value="">Sélectionner une catégorie</option>
                <option value="evenement">Événement</option>
                <option value="international">International</option>
                <option value="formation">Formation</option>
                <option value="recherche">Recherche</option>
                <option value="etudiants">Étudiants</option>
                <option value="infrastructure">Infrastructure</option>
              </select>
            </div>

            <!-- Image -->
            <div class="bg-white p-6 rounded-lg shadow-soft">
              <h3 class="text-lg font-medium text-gray-900 mb-4">Image de l'événement</h3>
              <div class="space-y-4">
                <div>
                  <input 
                    type="file" 
                    id="event-image" 
                    name="event_image"
                    accept="image/*"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                  />
                </div>
                <div id="image-preview" class="hidden">
                  <img id="preview-img" src="" alt="Aperçu" class="w-full h-32 object-cover rounded-md" />
                </div>
              </div>
            </div>

            <!-- Contact -->
            <div class="bg-white p-6 rounded-lg shadow-soft">
              <h3 class="text-lg font-medium text-gray-900 mb-4">Contact</h3>
              <div class="space-y-4">
                <div>
                  <label for="contact-name" class="block text-sm font-medium text-gray-700 mb-2">Nom du contact</label>
                  <input 
                    type="text" 
                    id="contact-name" 
                    name="contact_name"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                  />
                </div>
                <div>
                  <label for="contact-email" class="block text-sm font-medium text-gray-700 mb-2">Email du contact</label>
                  <input 
                    type="email" 
                    id="contact-email" 
                    name="contact_email"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                  />
                </div>
                <div>
                  <label for="contact-phone" class="block text-sm font-medium text-gray-700 mb-2">Téléphone du contact</label>
                  <input 
                    type="tel" 
                    id="contact-phone" 
                    name="contact_phone"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Gestion de l'inscription
    document.getElementById('registration-required').addEventListener('change', function(e) {
      const details = document.getElementById('registration-details');
      if (e.target.checked) {
        details.classList.remove('hidden');
      } else {
        details.classList.add('hidden');
      }
    });

    // Prévisualisation de l'image
    document.getElementById('event-image').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('preview-img').src = e.target.result;
          document.getElementById('image-preview').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      }
    });

    // Sauvegarde en brouillon
    function saveAsDraft() {
      document.getElementById('status').value = 'draft';
      document.getElementById('event-form').submit();
    }

    // Soumission du formulaire
    document.getElementById('event-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      const data = Object.fromEntries(formData);
      
      try {
        const response = await fetch('/api/events', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });

        const result = await response.json();
        
        if (result.success) {
          alert('Événement sauvegardé avec succès !');
          window.location.href = '/admin/evenements';
        } else {
          alert('Erreur lors de la sauvegarde : ' + result.message);
        }
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de la sauvegarde de l\'événement');
      }
    });
  </script>
</Layout>